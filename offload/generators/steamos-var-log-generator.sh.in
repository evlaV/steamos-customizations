#!/bin/bash
# -*- mode: sh; indent-tabs-mode: nil; sh-basic-offset: 4; -*-
# vim: et sts=4 sw=4

#  SPDX-License-Identifier: LGPL-2.1+
#
#  Copyright © 2019 Collabora Ltd.
#  Copyright © 2019 Valve Corporation.
#
#  This file is part of steamos-customizations.
#
#  steamos-customizations is free software; you can redistribute it and/or modify
#  it under the terms of the GNU Lesser General Public License as published
#  by the Free Software Foundation; either version 2.1 of the License, or
#  (at your option) any later version.

# This generator determines what's the backend for /var/log, which is actually
# offloaded to /home. It might be `/home/<...>/log-A` or `/home/<...>/log-B`.

set -e
set -u

NORMAL_DIR="$1"
EARLY_DIR="$2"
LATE_DIR="$3"

UNITS_DIR=$NORMAL_DIR
OFFLOAD_DIR=@offload_absdir@
UDEV_SYMLINKS_DIR=@udev_symlinks_absdir@

[ -d "$UDEV_SYMLINKS_DIR" ] || exit 0

logdir=
rootfs_a="$(readlink -f $UDEV_SYMLINKS_DIR/all/rootfs-A)"
rootfs_b="$(readlink -f $UDEV_SYMLINKS_DIR/all/rootfs-B)"
rootfs_self="$(readlink -f $UDEV_SYMLINKS_DIR/self/rootfs)"

if [ "$rootfs_self" = "$rootfs_a" ]; then
    logdir="$OFFLOAD_DIR/var/log-A"
elif [ "$rootfs_self" = "$rootfs_b" ]; then
    logdir="$OFFLOAD_DIR/var/log-B"
else
    echo >&2 "Rootfs neither A or B? No good..."
    exit 0
fi

MOUNT_UNIT="\
# Automatically generated by $(basename $0)

[Unit]
Description=SteamOS Offload - /var/log
Documentation=man:systemd.generator(7)

[Mount]
What=$logdir
Where=/var/log
Type=none
Options=bind

[Install]
WantedBy=steamos-offload.target"

mkdir -p "$UNITS_DIR"
echo "$MOUNT_UNIT" > "$UNITS_DIR/var-log.mount"

mkdir -p "$UNITS_DIR/steamos-offload.target.wants"
ln -sr "$UNITS_DIR/var-log.mount" "$UNITS_DIR/steamos-offload.target.wants/"
