#!/bin/bash
# -*- mode: sh; indent-tabs-mode: nil; sh-basic-offset: 4; -*-
# vim: et sts=4 sw=4

#  SPDX-License-Identifier: LGPL-2.1+
#
#  Copyright © 2019 Collabora Ltd.
#  Copyright © 2019 Valve Corporation.
#
#  This file is part of steamos-customizations.
#
#  steamos-customizations is free software; you can redistribute it and/or modify
#  it under the terms of the GNU Lesser General Public License as published
#  by the Free Software Foundation; either version 2.1 of the License, or
#  (at your option) any later version.

# This generator determines what's the backend for /var/log, which is actually
# offloaded to /home. It might be `/home/<...>/log-A` or `/home/<...>/log-B`.

set -e
set -u

NORMAL_DIR="$1"
EARLY_DIR="$2"
LATE_DIR="$3"

UNITS_DIR=$NORMAL_DIR
OFFLOAD_DIR=@offload_absdir@
UDEV_SYMLINKS_DIR=@udev_symlinks_absdir@

[ -d "$UDEV_SYMLINKS_DIR" ] || exit 0

make_mount_unit() {

    # Output a mount unit to stdout

    local what=$1
    local where=$2

    echo "\
# Automatically generated by $(basename $0)

[Unit]
Description=SteamOS Offload - $where
Documentation=man:systemd.generator(7)

[Mount]
What=$what
Where=$where
Type=none
Options=bind

[Install]
WantedBy=steamos-offload.target"
}

logdir_self=
logdir_other=
rootfs_a="$(readlink -f $UDEV_SYMLINKS_DIR/all/rootfs-A)"
rootfs_b="$(readlink -f $UDEV_SYMLINKS_DIR/all/rootfs-B)"
rootfs_self="$(readlink -f $UDEV_SYMLINKS_DIR/self/rootfs)"

if [ "$rootfs_self" = "$rootfs_a" ]; then
    logdir_self="$OFFLOAD_DIR/var/log-A"
    logdir_other="$OFFLOAD_DIR/var/log-B"
elif [ "$rootfs_self" = "$rootfs_b" ]; then
    logdir_self="$OFFLOAD_DIR/var/log-B"
    logdir_other="$OFFLOAD_DIR/var/log-A"
else
    echo >&2 "Rootfs neither A or B? No good..."
    exit 0
fi

mkdir -p "$UNITS_DIR"
make_mount_unit $logdir_self /var/log > "$UNITS_DIR/var-log.mount"
make_mount_unit $logdir_self /run/steamos/mnt/log-self > "$UNITS_DIR/run-steamos-mnt-log-self.mount"
make_mount_unit $logdir_other /run/steamos/mnt/log-other > "$UNITS_DIR/run-steamos-mnt-log-other.mount"

mkdir -p "$UNITS_DIR/steamos-offload.target.wants"
for unit_name in var-log run-steamos-mnt-log-self run-steamos-mnt-log-other; do
    ln -sr "$UNITS_DIR/$unit_name.mount" "$UNITS_DIR/steamos-offload.target.wants/"
done
