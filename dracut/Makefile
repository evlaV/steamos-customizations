include ../common.mk

ALPM_HOOKS_IN := $(wildcard alpm/hooks/*.in)
ALPM_HOOKS := $(patsubst %.in,%,$(ALPM_HOOKS_IN))
ALPM_SCRIPTS_IN := $(wildcard alpm/scripts/*.in)
ALPM_SCRIPTS := $(patsubst %.in,%,$(ALPM_SCRIPTS_IN))
BINARIES_IN := $(wildcard bin/*.in)
BINARIES := $(patsubst %.in,%,$(BINARIES_IN))
COMPLETIONS := $(wildcard completions/*)
GEN_MOD_IN := modules.d/module-setup.sh.in
MODULES_IN := $(wildcard modules.d/*.sh.in) $(GEN_MOD_IN)
MODULES := $(patsubst %.in,%,$(MODULES_IN))
README := modules.d/README
CLEANABLE := $(BINARIES) $(ALPM_SCRIPTS) $(ALPM_HOOKS) $(GEN_MOD_IN) $(MODULES)

modules.d/module-setup.sh.in: modules.d/module-setup.tmpl ../initrd/steamos-files.bash
	../initrd/inline-file.sh "@STEAMOS_BINARIES@" $^ > $@

all: $(BINARIES) $(ALPM_SCRIPTS) $(ALPM_HOOKS) $(GEN_MOD_IN) $(MODULES)

install: all
	install -d $(DESTDIR)$(sbindir)
	install -m 0755 $(BINARIES) $(DESTDIR)$(sbindir)
	install -d $(DESTDIR)$(completionsdir)
	install -m 0644 $(COMPLETIONS) $(DESTDIR)$(completionsdir)
	install -d $(DESTDIR)$(sysconfdir)/dracut.conf.d
	install -d $(DESTDIR)$(libdir)/dracut/modules.d/60steamos
	install -m 0755 $(MODULES) $(DESTDIR)$(libdir)/dracut/modules.d/60steamos
	install -m 0644 $(README)  $(DESTDIR)$(libdir)/dracut/modules.d/60steamos
	install -d $(DESTDIR)$(datadir)/libalpm/hooks
	install -m 644 $(ALPM_HOOKS) $(DESTDIR)$(datadir)/libalpm/hooks
	install -d $(DESTDIR)$(datadir)/libalpm/scripts
	install -m 755 $(ALPM_SCRIPTS) $(DESTDIR)$(datadir)/libalpm/scripts
