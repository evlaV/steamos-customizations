#!/bin/bash

#  SPDX-License-Identifier: LGPL-2.1+
#
#  Copyright © 2023 Collabora Ltd.
#  Copyright © 2023 Valve Corporation.
#
#  This file is part of steamos-customizations.
#
#  steamos-customizations is free software; you can redistribute it and/or
#  modify it under the terms of the GNU Lesser General Public License as
#  published by the Free Software Foundation; either version 2.1 of the License,
#  or (at your option) any later version.

set -eu

declare -r libdir=$(dirname $0)
declare line pkgbase preset conf_name conf_src new_conf
declare -a generated=()

dynamic_configs ()
{
    local preset=$1
    local var name conf
    (. $preset
     while read var
     do
         case $var in
             *_config)
                 name=${var%_config}
                 typeset -n var
                 conf=$var
                 typeset +n var
                 echo "$name" "$conf"
                 ;;
         esac
     done < <(compgen -v))
}

while read -r line
do
    if [[ $line != */vmlinuz ]]
    then
        # triggers when it's a change to usr/lib/initcpio/*
        continue
    fi

    if ! read -r pkgbase > /dev/null 2>&1 < "${line%/vmlinuz}/pkgbase"
    then
        # if the kernel has no pkgbase, we skip it
        continue
    fi

    # this may have been generated by 90-mkinitcpio-install or it
    # may already have been processed by us, figure out which:
    preset="/etc/mkinitcpio.d/${pkgbase}.preset"

    # preset doesn't exist at all - either restore from pacsave or
    # generate from template (and remove any stale stamp files):
    if [[ ! -e $preset ]]
    then
        rm -f $preset.generated

        if [[ -e $preset.pacsave ]]
        then
            mv "${preset}.pacsave" "$preset"
        else
            # create the preset from the template
            sed "s|%PKGBASE%|${pkgbase}|g" /usr/share/mkinitcpio/hook.preset \
                | install -Dm644 /dev/stdin "$preset"
        fi
    fi

    # preset is newer then our gen-stamp, or our genstamp does not exist:
    if [ $preset -nt $preset.generated ]
    then
        while read conf_name conf_src
        do
            new_conf=/etc/mkinitcpio.d/"$conf_name".dynamic.conf
            $libdir/streamline-mkinitcpio-config "$conf_src" "$new_conf"
        done < <(dynamic_configs $preset)

        $libdir/streamline-mkinitcpio-config $preset
        touch $preset.generated
    fi

    # install the kernel
    install -Dm644 "${line}" "/boot/vmlinuz-${pkgbase}"

    preset=${preset#/etc/mkinitcpio.d/}
    preset=${preset%.preset}
    generated+=($preset)
done

for preset in "${generated[@]}"
do
    mkinitcpio -p $preset
done

    
