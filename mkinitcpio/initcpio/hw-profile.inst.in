#!/bin/bash

declare _reason

cache_hw_module () {
    # canonicalise the module name to the module path filename
    # as this is what mkinitcpio uses internally as an identifier:
    local name=
    local file=$(modinfo -b "$_optmoduleroot" \
                         -k $KERNELVERSION \
                         -F filename "$1" 2>/dev/null)

    if [ "$file" = "(builtin)" ]
    then
        msg "Kernel module $1 is builtin ($_reason)"
        return 0
    fi

    if [ -z "$file" ]
    then
        msg "Kernel module $1 not configured in $KERNELVERSION ($_reason)"
        return 0
    fi

    name=${file##*/}
    name=${name%.ko*}

    if [ "${_autodetect_cache[$name]:-0}" != 1 ]
    then
        msg "Adding kernel module $name ($_reason)"
        add_module "$name"
        _autodetect_cache["$name"]=1
    fi
}

build() {
    # make sure we can access common filesystems when
    # we drop to an emergency shell, even if not in config:
    _reason="required by mkinitcpio hw-profile"
    map cache_hw_module btrfs ext4 ext3 vfat fat exfat overlay

    # QEMU_MODULES is a bash array of kernel modules required for qemu support
    # It is set in our preset file:
    if (( ${#QEMU_MODULES[@]} ))
    then
        _reason="required by QEMU_MODULES"
        map cache_hw_module "${QEMU_MODULES[@]}"
    fi

    # HW_PROFILE_MODULES is a bash array of the minimal module set we want
    # in our hw-specific initrd (for booting and emergency debugging)
    # it is typically set in preset file:
    if (( ${#HW_PROFILE_MODULES[@]} ))
    then
        _reason="required by HW_PROFILE_MODULES"
        map cache_hw_module "${HW_PROFILE_MODULES[@]}"
    else
        msg "Warning: hw-profile module invoked but HW_PROFILE_MODULES unset"
    fi
}

help() {
    cat <<'HELPEOF'
This hook specifies the minimal set of initrd modules required by the
target hardware (roughly what mkinitcpio autodetect would do, plus a 
few modules we think would be useful for debugging/testing/vms).

It does this by piggybacking on the same mechanism as autodetect,
which means that it can be used alongside autodetect even if running
on a vm during the CI/build process.
HELPEOF
}
